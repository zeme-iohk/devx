# DevX 

The `devx` flake provisions a development environment suitable for working on a `haskell.nix` project.

It includes a complete haskell toolchain as well as all the native dependencies needed to work with other haskell IOG repositories.

# Test that `devx` can build your Haskell project 

Pick your `ghc` version (one of `ghc8107`, `ghc901`, `ghc924`), and enter the shell:
```
nix develop github:zeme-iohk/devx#ghc8107 --no-write-lock-file
```
You may now build and test your project:
```
cabal update
cabal build all -j 
cabal test all 
```

If you wish to use `devx` in your project:
- If you have a new repository then [click here](#integration-with-a-new-repository) for instructions.
- If you wish to migrate your existing nix code then [click here](#integration-with-an-existing-repository) instead.

# Integration with a new repository 

If this is a new repository, you should use the flake template.

```
nix flake init --template github:zeme-iohk/devx
```

Two files will be created in the top-level: `flake.nix` and `devx.nix`.

[Click here](#the-devx-flakenix-file) to continue learning.

# Integration with an existing repository

In order to successully migrate to `devx` your nix code will have to be refactored until your `flake.nix` is standardized (see [here](#the-standard-flakenix-file)) and your `devx.nix` file (which you have to create) becomes the entrypoint to all your nix code (see [here](#the-devxnix-file)).

# The standard `flake.nix` file

Projects using `devx` share an almost identical `flake.nix`:
```nix
{
  description = "";

  inputs.devx.url = "github:zeme-iohk/devx";

  # You can add other flake inputs here if you must: inputs.other = {}

  outputs = inputs.devx.lib.mkFlakeOutputs;

  nixConfig = {
    extra-substituters = [
      "https://cache.iog.io"
      "https://cache.zw3rk.com"
    ];
    extra-trusted-public-keys = [
      "hydra.iohk.io:f/Ea+s+dFdN+3Y/G+FDgSq+a5NEWhJGzdjvKNGv0/EQ="
      "loony-tools:pr9m4BkM/5/eSTZlkQyRt57Jz7OMBxNSUiMC4FkcNfk="
    ];
    accept-flake-config = true;
    allow-import-from-derivation = true;
  };
}
```
You may edit this file in three ways:
1. Fill the `description` to your liking.
2. Edit the `nixConfig` attrset, but do not **no** invalidate the cache-related fields.
3. Add new inputs to the flake. *Note that `devx` provisions and manages all other flake inputs, and therefore should be the only input in your flake. You may nonetheless declare additional inputs as you would normally, and they will be available in `devx.nix`.*

# The `devx.nix` file

The `devx.nix` file is the entrypoint to all your nix code:
```nix
devx: 
{
  supportedSystems = ["x86_64-linux" "x86_64-darwin"]; 
  
  ghcVersions = ["ghc8107" "ghc901" "ghc924"]; 

  haskellNixProject = ./haskell.nix;

  extraFlakeOutputs = {};

  shellHooks = {
    default = {
      hook1-name = ''bash code'';
      hook2-name = ''bash code'';
    };
    shell1 = {};
    shell2 = {};
  };

  shellCommands = {
    default = {
      command1-name = {
        description = "";
        category = "";
        exec = "bash code";
      };
      command2-name = {
        description = "";
        category = "";
        exec = "bash code";
      };
    }];
    shell1 = {};
    shell2 = {};
  };
}
```
    
- `supportedSystems` should be any of "x86_64-linux" "x86_64-darwin" "aarch64-linux" "aarch64-darwin".
  Flake outputs for packages and devshells will be produced for each supported system.
    
- `ghcVersions` should be any of "ghc8106" "ghc901" "ghc924". This will determine the version of the haskell toolchain. A devShell will be avaiable for each GHC version.

- `haskellNixProject` path to a standard `./haskell.nix` file. Click [here](#the-haskellnix-file) for reference. 

- `extraFlakeOutputs` should have the same format as standard flake outputs. The outputs will be merged with the outputs generated by `devx` (more on this below).

- `shellHooks.{shellName}` is an attrs where each key is the hook name and each value is bash code to be executed each time that devShell is entered.

- `shellCommands.{shellName}` is an attrs where each key is the command name and each value is an attrs defining the command. A menu of available commands is displayed upon entering that devShell. Commands are grouped by `category`.

# The `devx` attribute set 

The `devx` attribute set contains everything that you'll need in your nix code.
```nix
devx = {
  self = {}; 
  inputs = {};
  outputs = {};
  lib = {
    mkFlakeOutputs = {};
  };
}
```

- `self`: the standard "self" flake input.

- `inputs`: the desystemized inputs coming from `flake.nix` plus the desystemized implicit inputs. The implicit inputs are: 
  - `nixpkgs`
  - `haskell-nix`
  - `hackage-nix`
  - `CHaP`
  - `iohk-nix`
  - TODO unexhaustive list

- `outputs`: the final outputs coming from `devx.nix`'s `extraFlakeOutputs` plus the implicit outputs. The implicit outputs are:
  - `packages`:
      - `default`: references `packages.{ghcVersion}` where `ghcVersion` is the first GHC listed in `devx.nix`'s `ghcVersions`.
      - `{ghcVersion}`: All haskell-nix executables, testsuites, benchmarks and libraries.
      - TODO document the format of the haskell-nix components
      - TODO add crossCompiling packages 
      - TODO add codeCoverage support 
      - TODO add haddock support 
  - `apps`:
      - `default`: references `apps.{ghcVersion}` where `ghcVersion` is the first GHC listed in `devx.nix`'s `ghcVersions`.
      - `{ghcVersion}`: All haskell-nix executables, testsuites, and benchmarks.
      - TODO document the format of the haskell-nix components
  - `devShells`:
      - `default`: references `devShells.{ghcVerions}` where `ghcVersion` is the first GHC listed in `devx.nix`'s `ghcVersions`.
      - `{ghcVersion}`: The main devShell with the given `{ghcVersion}`.
      - `{ghcVersion}-prof`: Same as above, but all haskell components have profiling enabled.

- `lib.mkFlakeOutputs`: use this in `flake.nix` 

# The `haskell.nix` file 

TODO