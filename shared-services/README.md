# DevX 

The `devx` flake provisions a development environment suitable for working on a `haskell.nix` project.

It includes a complete haskell toolchain as well as all the native dependencies needed to work with other haskell IOG repositories.

# Test that `devx` can build your Haskell project 

Pick your `ghc` version, for example `ghc942`, and enter the shell:
```
nix develop github:zeme-iohk/devx#ghc942 --no-write-lock-file
```
You may now build and test your project:
```
cabal update
cabal build all -j 
cabal test all 
```

If you wish to use `devx` in your project then [click here](#integration-with-a-new-repository) if this is a new repository, otherwise [click here](#integration-with-an-existing-repository).

# Integration with a new repository 

If this is a new repository, you should use the flake template.

```
nix flake init --template github:zeme-iohk/devx
```

Two files will be created in the top-level: `flake.nix` and `devx.nix`.

[Click here](#the-devx-flakenix-file) to continue learning.

# Integration with an existing repository

In order to successully migrate to `devx` your nix code will have to be refactored until your `flake.nix` is standardized (see [here](#the-standard-flakenix-file)) and your `devx.nix` file (which you have to create) becomes the entrypoint to all your nix code (see [here](#the-devxnix-file)).

# The standard `flake.nix` file

Projects using `devx` share an almost identical `flake.nix`:
```nix
{
  description = "";

  inputs.devx.url = "github:input-output-hk/devx?ref=zeme-iohk/shared-services";

  # You can add other flake inputs here if you must: inputs.other = {}

  outputs = inputs.devx.lib.mkFlake;

  nixConfig = {
    extra-substituters = [
      "https://cache.iog.io"
      "https://cache.zw3rk.com"
    ];
    extra-trusted-public-keys = [
      "hydra.iohk.io:f/Ea+s+dFdN+3Y/G+FDgSq+a5NEWhJGzdjvKNGv0/EQ="
      "loony-tools:pr9m4BkM/5/eSTZlkQyRt57Jz7OMBxNSUiMC4FkcNfk="
    ];
    accept-flake-config = true;
    allow-import-from-derivation = true;
  };
}
```
You may edit this file in three ways:
1. Fill the `description` to your liking.
2. Edit the `nixConfig` attrset, but do not **no** invalidate the cache-related fields.
3. Add new inputs to the flake. *Note that `devx` provisions and manages all other flake inputs, and therefore should be the only input in your flake. You may nonetheless declare additional inputs as you would normally, and they will be available in `devx.nix`.*

[Click here](#the-devxnix-file) to continue learning.

# The `devx.nix` file

The `devx.nix` file is the entrypoint to all your nix code.
Below is a reference template:
```nix
devx: 
{
  supportedSystems = ["x86_64-linux" "x86_64-darwin"]; 
  
  ghcVersions = ["ghc8107", "ghc924]; 

  haskellNixProject = ./haskell.nix;

  extraFlakeOutputs = {};

  shellHooks = {
    default = {
      hook1-name = ''bash code'';
      hook2-name = ''bash code'';
    };
    shell1 = {};
    shell2 = {};
  };

  shellCommands = {
    default = {
      command1-name = {
        description = "";
        category = "";
        exec = "bash code";
      };
      command2-name = {
        description = "";
        category = "";
        exec = "bash code";
      };
    }];
    shell1 = {};
    shell2 = {};
  };
}
```
    
- `supportedSystems` should be any of "x86_64-linux" "x86_64-darwin" "aarch64-linux" "aarch64-darwin".
  Flake outputs for packages and devshell will be produced for each supported system.
    
- `ghcVersions` should be any of "ghc8106" "ghc924" "ghc965". This will determine the version of the haskell toolchain. A devshell will be avaiable for each ghc version.

- `extraFlakeOutputs` should have the same format as standard flake outputs. 
  The outputs will be merged with the outputs generated by `devx`.

- `shellHooks.{shellName}` is an attrs where each key is the hook name and each value is bash code to be executed each time that shell is entered.

- `shellCommands.{shellName}` is an attrs where each key is the command name and each value is an attrs defining the command. A menu of available commands is displayed upon entering that shell. Commands are grouped by `category`.

[Click here](#the-devx-attribute-set) to continue learning.

# The `devx` attribute set 

The `devx` attribute set contains everything that you'll need in your nix code.
```nix
devx = {
  self = {}; 
  inputs = {};
  outputs = {};
  lib = {
    mkFlake = {};
  };
}
```

- `self`: the standard "self" flake input.

- `inputs`: the desystemized inputs coming from `flake.nix` plus the desystemized implicit inputs. The implicit inputs are: `CHaP`, `iohk-nix`, `haskell-nix`, `nixpkgs`, `hackage-nix`.

- `outputs`: the final outputs coming from `devx.nix`'s `extraFlakeOutputs` plus the implicit outputs. The implicit outputs are:
  - `packages`:
      `default`: references `packages.{ghcVersion}` where `ghcVersion` is the first GHC listed in `devx.nix`'s `ghcVersions`.
      `{ghcVersion}`: All haskell-nix executables, testsuites, benchmarks and libraries.
  - `apps`:
      `default`: references `apps.{ghcVersion}` where `ghcVersion` is the first GHC listed in `devx.nix`'s `ghcVersions`.
      `{ghcVersion}`: All haskell-nix executables, testsuites, and benchmarks.
  - `devShells`:
      `default`: devshell with the first GHC listed in `devx.nix`'s `ghcVersions`.
      `{ghcVersion}`: One devshell for each GHC listed in `devx.nix`'s `ghcVersions`. 
      `{ghcVersion}-prof`: One devshell for each GHC listed in `devx.nix`'s `ghcVersions`, with profiling enabled.

- `lib.mkFlake`: use this in `flake.nix` 
